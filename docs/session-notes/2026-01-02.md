# Session Notes - January 3, 2026

## Summary
Major quote system improvements: added products to Edit Quote page, fixed quote saving, added price breakdown for customers, and simplified navigation.

---

## Latest Fixes (Session 4 - Jan 3)

### Quote/Order Mode Toggle Verified
The `/quotes/new` page has a working Quote vs Confirmed Order toggle:

**Features:**
- Button-group toggle: Quote (pink) | Confirmed Order (green)
- Status badge: DRAFT for Quote, CONFIRMED for Order
- Save button always visible: "Save Quote" or "Create Order"
- Budget Range fields only shown in Quote mode

**How it works:**
- **Quote Mode**: Saves via POST to `/api/quotes` with DRAFT status
- **Order Mode**: Uses `createOrder` server action with CONFIRMED status

**Implementation:**
- State variable: `isOrderMode` boolean (`app/quotes/new/page.tsx:111`)
- Toggle UI: Lines 843-864
- Dual save logic: Lines 629-802
- Products included in calculations: Lines 382-391

**Home Page Button Fixed:**
- "Create New Cake Order" button on Orders list (`app/page.tsx:48`) now links to `/quotes/new`

---

## Latest Fixes (Session 3)

### 1. Product Packaging Fix
**Issue:** Cupcake liners (default packaging) were not being saved when adding products in quotes.

**Root Cause:** ProductSelector uses `packagingSelections` array, but save code was looking at legacy `packagingId` field.

**Fixes Applied:**
- `app/quotes/[id]/edit/page.tsx` - Updated save to use `packagingSelections[0]` if available
- `app/quotes/new/page.tsx` - Same fix for new quotes

### 2. Quotes List Page Enhanced
**New Features:**
- Quote amount displayed (from locked costing)
- Status timestamp (Created/Sent/Accepted dates)
- Action buttons: View, Edit, Revise, Delete
- Version number shown in status badge

**Files Changed:**
- `app/quotes/page.tsx` - Converted to client component with SWR
- `app/api/quotes/[id]/route.ts` - Added DELETE endpoint

### 3. Unsaved Changes Warning
**Added:** Warning when leaving Edit Quote with unsaved changes
- Yellow "Unsaved changes" badge appears
- Browser beforeunload warning
- Confirmation dialog on back button

**Files Changed:**
- `app/quotes/[id]/edit/page.tsx` - Added state tracking and warnings

---

## Session 2 Fixes

### Product Regression Fix
**Issue:** When creating a new quote version (v2), products were not being copied, causing the quote to revert to an incorrect price (e.g., $970.50 instead of $1,175.93).

**Root Cause:** Two API routes were missing QuoteItem handling:
1. `app/api/quotes/[id]/revise/route.ts` - didn't include or copy QuoteItem
2. `app/api/quotes/[id]/convert/route.ts` - didn't include or copy QuoteItem to OrderItem

**Fixes Applied:**

1. **Revise Route** (`app/api/quotes/[id]/revise/route.ts`):
   - Added `QuoteItem: true` to the Prisma include
   - Added loop to copy all QuoteItem records to the new revision
   - Added missing fields: `depositType`, `depositAmount`, `priceAdjustment`, `budgetMin`, `budgetMax`

2. **Convert Route** (`app/api/quotes/[id]/convert/route.ts`):
   - Added `QuoteItem: true` to the Prisma include
   - Added loop to create OrderItem from QuoteItem (products)

**Result:** Quote revisions and order conversions now properly include all products.

---

## What We Fixed/Added

### 1. Products in Edit Quote
Previously, products (cupcakes, cake pops, etc.) could only be added when creating a new quote. Now:
- **Edit Quote page** has "Additional Products" section using `ProductSelector` component
- Products load from existing quote data when editing
- Products are included in cost calculations
- Products save correctly via PUT API

**Files changed:**
- `app/quotes/[id]/edit/page.tsx` - Added ProductSelector, state, load/save logic
- `app/api/quotes/[id]/route.ts` - Added products handling in PUT, fixed relation names (Customer/DeliveryZone)

### 2. Quote Detail View Updates
- Products now display in "Additional Products" section on quote detail page
- Products included in costing calculation
- **Customer view price breakdown** shows itemized pricing:
  - Cake price (e.g., "3-Tier Cake: $XXX")
  - Each product with quantity and price
  - Delivery, Discount, Total

**Files changed:**
- `app/quotes/[id]/page.tsx` - Added QuoteItem include, products in quoteInput, serialization
- `app/quotes/[id]/QuoteDetailClient.tsx` - Added quoteItems/products interfaces, display sections

### 3. Quote System Fixes (from earlier session)
- **Quote number conflict** - Auto-retries with new number on P2002 conflict
- **Discount section** - Added to Edit Quote page
- **Deposit options** - Default %, Custom %, or Fixed $ amount
- **Price adjustment** - Round up/down with internal/customer views
- **Print layout** - Quote total appears before Terms & Conditions

### 4. Navigation Simplified
Menu reduced to: New Order, Orders, Quotes, Production, Admin
- Removed duplicate "New Quote" link
- Reordered for better workflow

**Files changed:**
- `app/layout.tsx`

---

## Database Schema Updates
Added fields to Quote model:
- `depositType` (String) - 'PERCENT' or 'FIXED'
- `depositAmount` (Decimal) - Fixed dollar amount for deposit
- `priceAdjustment` (Decimal) - +/- adjustment to round price

---

## Current State

### Build Status
- **Build passes** - All 88 pages compile successfully

### Test Data
- 15 test orders (#46-60) across Jan 2-15, 2026
- 105 production tasks generated

### Dev Server
Running at `http://localhost:3000`

---

## Testing Checklist

### Quote with Products
1. Go to `/quotes/new`
2. Add customer, tiers, products (cupcakes, etc.)
3. Save quote
4. View quote detail - products should appear
5. Edit quote - products should be loaded
6. Modify products, save
7. View again - changes should persist

### Customer View Price Breakdown
1. Open any quote with products
2. Switch to "Customer View"
3. Sidebar should show:
   - Cake: $XXX
   - Product x qty: $XXX
   - Delivery: $XXX (if applicable)
   - Total: $XXX

---

## Commands

```bash
# Kill existing server
lsof -ti:3000 | xargs kill -9

# Start dev server
npm run dev

# Build check
npm run build
```

---

## Next Steps
- ~~Test full quote-to-order conversion with products~~ ✓ Fixed
- ~~Verify products appear on converted orders~~ ✓ Fixed
- Test print/PDF with products breakdown
- Test creating a new quote version (v2, v3) - products should now copy correctly
