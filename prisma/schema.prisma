generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Ingredient {
  id                Int                 @id @default(autoincrement())
  name              String              @unique
  unit              String
  costPerUnit       Decimal             @db.Decimal(10, 6)
  recipeIngredients RecipeIngredient[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

enum RecipeType {
  BATTER
  FILLING
  FROSTING
}

model Recipe {
  id                Int                 @id @default(autoincrement())
  name              String              @unique
  type              RecipeType
  yieldDescription  String
  yieldVolumeMl     Int?                // Volume this recipe yields in ml (for multiplier calculation)

  // Step-by-step instructions with time tracking
  instructions      String?             // JSON array of steps: [{step: 1, description: "...", minutes: 5, type: "prep"}, ...]
  prepMinutes       Int?                // Total active prep time (mixing, measuring)
  bakeMinutes       Int?                // Bake/cook time
  coolMinutes       Int?                // Cooling/resting time

  laborMinutes      Int?                // Total labor time (auto-calculated from instructions or manual)
  laborRoleId       Int?                // Who prepares this (typically Baker)
  laborRole         LaborRole?          @relation(fields: [laborRoleId], references: [id])
  recipeIngredients RecipeIngredient[]
  cakeTiers         CakeTier[]          @relation("BatterRecipe")
  fillingTiers      CakeTier[]          @relation("FillingRecipe")
  frostingTiers     CakeTier[]          @relation("FrostingRecipe")
  quoteBatterTiers   QuoteTier[]         @relation("QuoteBatterRecipe")
  quoteFillingTiers  QuoteTier[]         @relation("QuoteFillingRecipe")
  quoteFrostingTiers QuoteTier[]         @relation("QuoteFrostingRecipe")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model RecipeIngredient {
  id           Int        @id @default(autoincrement())
  recipeId     Int
  ingredientId Int
  quantity     Decimal    @db.Decimal(10, 3)
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([recipeId, ingredientId])
}

model TierSize {
  id                  Int        @id @default(autoincrement())
  name                String     @unique
  shape               String     @default("Round")

  // Dimensions - stored in cm, displayed in both cm and inches
  diameterCm          Decimal    @db.Decimal(10, 2)  // For round/heart shapes
  lengthCm            Decimal?   @db.Decimal(10, 2)  // For rectangular/sheet shapes
  widthCm             Decimal?   @db.Decimal(10, 2)  // For rectangular/sheet shapes
  heightCm            Decimal    @db.Decimal(10, 2)  // Layer height

  // Calculated volume for automatic multiplier calculation
  volumeMl            Int?       // Calculated volume in ml

  servings            Int

  // Assembly labor (filling, stacking, crumb coating)
  assemblyMinutes     Int?       // Time to fill, stack, crumb coat this tier size
  assemblyRoleId      Int?       // Who assembles this (typically Baker)
  assemblyRole        LaborRole? @relation(fields: [assemblyRoleId], references: [id])

  cakeTiers           CakeTier[]
  quoteTiers          QuoteTier[]
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
}

enum SkillLevel {
  LOW
  MEDIUM
  HIGH
}

// Labor roles with different hourly rates
model LaborRole {
  id                   Int                   @id @default(autoincrement())
  name                 String                @unique  // e.g., "Decorator", "Baker", "Bakery Assistant"
  description          String?               // e.g., "Skilled decoration work including fondant, piping, sugar flowers"
  hourlyRate           Decimal               @db.Decimal(10, 2)
  sortOrder            Int                   @default(0)
  isActive             Boolean               @default(true)
  recipes              Recipe[]
  tierSizes            TierSize[]
  decorationTechniques DecorationTechnique[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
}

enum MaterialGrade {
  STANDARD
  PREMIUM
  LUXURY
}

enum DecorationUnit {
  SINGLE  // Per-item decorations (e.g., sugar flowers, sculpted balloons) - quantity = number of items
  CAKE    // Whole cake decoration (no size scaling) - quantity = number of instances on whole cake
  TIER    // Tier-based decoration with size scaling - quantity = number of instances, scaled by tier size
  SET     // User-defined set of matching decorations - quantity = number of sets
}

model DecorationTechnique {
  id                   Int            @id @default(autoincrement())
  sku                  String         @unique
  name                 String
  category             String
  subcategory          String
  skillLevel           SkillLevel
  description          String
  unit                 DecorationUnit
  baseCakeSize         String         @default("6\" round")  // Base cake size/shape these costs are calculated for
  defaultCostPerUnit   Decimal        @db.Decimal(10, 2)
  laborMinutes         Int
  laborRoleId          Int?           // Which role performs this technique (null = use default Baker rate)
  laborRole            LaborRole?     @relation(fields: [laborRoleId], references: [id])
  wasteFactorPercent   Int
  materialGrade        MaterialGrade
  toolsRequired        String
  imageReference       String?
  isActive             Boolean        @default(true)
  orderDecorations     OrderDecoration[]
  quoteDecorations     QuoteDecoration[]
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
}

model OrderDecoration {
  id                    Int                 @id @default(autoincrement())
  cakeOrderId           Int
  decorationTechniqueId Int
  quantity              Int                 @default(1)
  notes                 String?
  cakeOrder             CakeOrder           @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  decorationTechnique   DecorationTechnique @relation(fields: [decorationTechniqueId], references: [id])
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([cakeOrderId, decorationTechniqueId])
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
}

enum DiscountType {
  PERCENT
  FIXED
}

enum CakeType {
  ROUND
  SHEET
  TIERED
  SCULPTED
  CUPCAKES
  OTHER
}

model Customer {
  id          Int         @id @default(autoincrement())
  name        String
  company     String?
  email       String?
  phone       String?
  address     String?
  birthday    DateTime?
  notes       String?
  orders      CakeOrder[]
  quotes      Quote[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([name])
  @@index([email])
  @@index([phone])
  @@index([company])
}

model CakeOrder {
  id               Int               @id @default(autoincrement())
  customerId       Int?
  customer         Customer?         @relation(fields: [customerId], references: [id])
  customerName     String?           // Legacy field for backwards compatibility
  eventDate        DateTime

  // Cake details
  cakeType         CakeType?
  size             String?           // Auto-calculated from tiers, e.g., "6 inch", "8 inch", "2-tier"
  servingsTarget   Int?              // Legacy field
  desiredServings  Int?              // Desired serving size for the entire order

  // Event details
  theme            String?
  occasion         String?
  colors           String?           // Comma-separated or JSON array of colors
  accentColors     String?           // Comma-separated or JSON array of accent colors

  // Delivery details
  isDelivery       Boolean           @default(false)
  deliveryZoneId   Int?
  deliveryZone     DeliveryZone?     @relation(fields: [deliveryZoneId], references: [id])
  deliveryDistance Decimal?          @db.Decimal(10, 2)  // miles - for per-mile fee calculation
  deliveryContact  String?
  deliveryPhone    String?
  deliveryTime     DateTime?
  deliveryAddress  String?

  // Labor - base prep hours by role (decoration labor is calculated from techniques)
  estimatedHours   Decimal           @db.Decimal(10, 2)  // Legacy: total hours (kept for backwards compatibility)
  bakerHours       Decimal?          @db.Decimal(10, 2)  // Hours for baking, assembly
  assistantHours   Decimal?          @db.Decimal(10, 2)  // Hours for simple tasks, packaging

  // Topper
  topperType       String?           // 'age', 'happy_birthday', 'its_a_boy', 'its_a_girl', 'initials', 'congratulations', 'custom', 'none'
  topperText       String?           // Custom text for topper (e.g., initials, custom message)
  customTopperFee  Decimal?          @db.Decimal(10, 2)  // Fee for custom toppers

  // Pricing
  markupPercent    Decimal?          @db.Decimal(10, 4)  // e.g., 0.70 for 70% markup, null = use default from settings

  // Discount
  discountType     DiscountType?     // PERCENT or FIXED
  discountValue    Decimal?          @db.Decimal(10, 2)  // Percentage (e.g., 10 for 10%) or fixed dollar amount
  discountReason   String?           // e.g., "Repeat customer", "Corporate rate", "Referral"

  notes            String?
  status           OrderStatus       @default(DRAFT)
  cakeTiers        CakeTier[]
  orderDecorations OrderDecoration[]
  convertedFromQuote Quote?            @relation("QuoteToOrder")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([customerId])
  @@index([eventDate])
  @@index([status])
}

model CakeTier {
  id          Int       @id @default(autoincrement())
  cakeOrderId Int
  tierIndex   Int
  tierSizeId  Int

  // Recipe selections (chosen per order, not locked to tier size)
  batterRecipeId      Int?
  batterMultiplier    Decimal?   @db.Decimal(10, 3)  // Auto-calculated from volume ratio
  fillingRecipeId     Int?
  fillingMultiplier   Decimal?   @db.Decimal(10, 3)
  frostingRecipeId    Int?
  frostingMultiplier  Decimal?   @db.Decimal(10, 3)

  // Legacy flavor fields (kept for backwards compatibility, will be deprecated)
  flavor      String?
  filling     String?
  finishType  String?

  cakeOrder       CakeOrder @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  tierSize        TierSize  @relation(fields: [tierSizeId], references: [id])
  batterRecipe    Recipe?   @relation("BatterRecipe", fields: [batterRecipeId], references: [id])
  fillingRecipe   Recipe?   @relation("FillingRecipe", fields: [fillingRecipeId], references: [id])
  frostingRecipe  Recipe?   @relation("FrostingRecipe", fields: [frostingRecipeId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([cakeOrderId, tierIndex])
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Field options for dropdowns (occasions, themes, colors, etc.)
model FieldOption {
  id        Int      @id @default(autoincrement())
  category  String   // 'occasion', 'theme', 'color', 'cakeSurface', 'flavor', 'filling'
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, name])
  @@index([category])
}

// Delivery zones with pricing
model DeliveryZone {
  id          Int         @id @default(autoincrement())
  name        String      @unique  // e.g., "Local (0-10 miles)", "Extended (10-25 miles)"
  description String?
  minDistance Decimal?    @db.Decimal(10, 2)  // miles
  maxDistance Decimal?    @db.Decimal(10, 2)  // miles
  baseFee     Decimal     @db.Decimal(10, 2)  // base delivery fee
  perMileFee  Decimal?    @db.Decimal(10, 2)  // additional per mile (optional)
  isActive    Boolean     @default(true)
  sortOrder   Int         @default(0)
  orders      CakeOrder[]
  quotes      Quote[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// Delivery start points (office, warehouse, etc.)
model DeliveryStartPoint {
  id          Int       @id @default(autoincrement())
  name        String    // e.g., "Main Office", "Warehouse", "Home Kitchen"
  address     String
  latitude    Decimal?  @db.Decimal(10, 7)
  longitude   Decimal?  @db.Decimal(10, 7)
  isDefault   Boolean   @default(false)
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Quote model for sales quotes before order confirmation
model Quote {
  id               Int               @id @default(autoincrement())
  quoteNumber      String            @unique  // e.g., "Q-2024-001"
  customerId       Int?
  customer         Customer?         @relation(fields: [customerId], references: [id])
  customerName     String            // Customer name (required even if customerId is set)
  
  // Event details
  eventDate        DateTime
  eventType        String?
  theme            String?
  occasion         String?
  colors           String?
  accentColors     String?
  
  // Cake details
  cakeType         CakeType?
  desiredServings  Int?

  // Customer budget (desired budget range or single value)
  budgetMin        Decimal?          @db.Decimal(10, 2)  // Minimum budget (or single budget if budgetMax is null)
  budgetMax        Decimal?          @db.Decimal(10, 2)  // Maximum budget (null if single value)

  // Delivery details
  isDelivery       Boolean           @default(false)
  deliveryZoneId   Int?
  deliveryZone     DeliveryZone?     @relation(fields: [deliveryZoneId], references: [id])
  deliveryDistance Decimal?          @db.Decimal(10, 2)
  deliveryContact  String?
  deliveryPhone    String?
  deliveryTime     DateTime?
  deliveryAddress  String?
  
  // Labor
  bakerHours       Decimal?          @db.Decimal(10, 2)
  assistantHours   Decimal?          @db.Decimal(10, 2)
  
  // Topper
  topperType       String?
  topperText       String?
  customTopperFee  Decimal?          @db.Decimal(10, 2)
  
  // Pricing
  markupPercent    Decimal           @db.Decimal(10, 4)  // e.g., 0.70 for 70% markup
  depositPercent   Decimal?          @db.Decimal(5, 2)   // e.g., 0.50 for 50%, 1.0 for full, null = use default
  discountType     DiscountType?
  discountValue    Decimal?          @db.Decimal(10, 2)
  discountReason   String?
  
  // Locked costs (when quote is accepted, costs are locked and not recalculated)
  lockedCosting    String?          @db.Text  // JSON string of CostingResult when accepted
  lockedAt         DateTime?        // When costs were locked (when status changed to ACCEPTED)
  
  // Quote metadata
  status           QuoteStatus       @default(DRAFT)
  expiresAt        DateTime?         // Quote expiration date
  notes            String?
  termsAndConditions String?         // Custom terms for this quote
  
  // Relationship to order (when quote is accepted)
  convertedOrderId Int?              @unique  // If quote was converted to order
  convertedOrder   CakeOrder?        @relation("QuoteToOrder", fields: [convertedOrderId], references: [id])

  // Version tracking for quote revisions
  version          Int               @default(1)  // Revision number (1 = original, 2 = first revision, etc.)
  originalQuoteId  Int?              // Links to the original quote for revisions
  originalQuote    Quote?            @relation("QuoteRevisions", fields: [originalQuoteId], references: [id])
  revisions        Quote[]           @relation("QuoteRevisions")  // All revisions of this quote

  // Quote tiers and decorations
  quoteTiers       QuoteTier[]
  quoteDecorations QuoteDecoration[]
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  sentAt           DateTime?         // When quote was sent to customer
  
  @@index([customerId])
  @@index([status])
  @@index([eventDate])
  @@index([quoteNumber])
}

model QuoteTier {
  id          Int       @id @default(autoincrement())
  quoteId     Int
  tierIndex   Int
  tierSizeId  Int
  
  // Recipe selections
  batterRecipeId      Int?
  batterMultiplier    Decimal?   @db.Decimal(10, 3)
  fillingRecipeId     Int?
  fillingMultiplier   Decimal?   @db.Decimal(10, 3)
  frostingRecipeId    Int?
  frostingMultiplier  Decimal?   @db.Decimal(10, 3)
  
  // Legacy flavor fields
  flavor      String?
  filling     String?
  finishType  String?
  
  quote       Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  tierSize    TierSize  @relation(fields: [tierSizeId], references: [id])
  batterRecipe    Recipe?   @relation("QuoteBatterRecipe", fields: [batterRecipeId], references: [id])
  fillingRecipe   Recipe?   @relation("QuoteFillingRecipe", fields: [fillingRecipeId], references: [id])
  frostingRecipe  Recipe?   @relation("QuoteFrostingRecipe", fields: [frostingRecipeId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([quoteId, tierIndex])
}

model QuoteDecoration {
  id                    Int                 @id @default(autoincrement())
  quoteId               Int
  decorationTechniqueId Int
  quantity              Int                 @default(1)
  unitOverride          DecorationUnit?     // Optional override of decoration's default unit for this quote
  tierIndices           Int[]               @default([]) // For TIER unit: which tier indices this decoration applies to (e.g., [1, 2])
  notes                 String?
  quote                 Quote                @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  decorationTechnique   DecorationTechnique @relation(fields: [decorationTechniqueId], references: [id])
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  @@unique([quoteId, decorationTechniqueId])
}