generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CakeOrder {
  id               Int               @id @default(autoincrement())
  customerName     String?
  eventDate        DateTime
  notes            String?
  servingsTarget   Int?
  estimatedHours   Decimal           @db.Decimal(10, 2)
  status           OrderStatus       @default(DRAFT)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime @updatedAt
  customerId       Int?
  size             String?
  cakeType         CakeType?
  colors           String?
  deliveryAddress  String?
  deliveryContact  String?
  deliveryPhone    String?
  deliveryTime     DateTime?
  isDelivery       Boolean           @default(false)
  occasion         String?
  theme            String?
  customTopperFee  Decimal?          @db.Decimal(10, 2)
  topperText       String?
  topperType       String?
  deliveryZoneId   Int?
  deliveryDistance Decimal?          @db.Decimal(10, 2)
  discountReason   String?
  discountType     DiscountType?
  discountValue    Decimal?          @db.Decimal(10, 2)
  assistantHours   Decimal?          @db.Decimal(10, 2)
  bakerHours       Decimal?          @db.Decimal(10, 2)
  accentColors     String?
  desiredServings  Int?
  markupPercent    Decimal?          @db.Decimal(10, 4)
  pickupTime       DateTime?
  imageUrl         String?           // Customer's cake design/inspiration photo
  isBulkOrder      Boolean           @default(false)
  bulkQuantity     Int?              // For bulk orders (e.g., 500 cupcakes)
  productionDays   Int?              // Number of days needed for production
  isRush              Boolean           @default(false)  // Rush order - may skip some batch steps
  rushSkipBatchTypes  String?           // JSON array of batch type codes to skip (e.g., ["BAKE"])
  Customer         Customer?         @relation(fields: [customerId], references: [id])
  DeliveryZone     DeliveryZone?     @relation(fields: [deliveryZoneId], references: [id])
  CakeTier              CakeTier[]
  OrderDecoration       OrderDecoration[]
  OrderItem             OrderItem[]
  OrderPackaging        OrderPackaging[]
  ProductionTask        ProductionTask[]
  Quote                 Quote?
  OrderAssignment       OrderAssignment?
  ProductionPrepSignoff ProductionPrepSignoff?
  InventoryReservation  InventoryReservation[]

  @@index([customerId])
  @@index([eventDate])
  @@index([status])
}

model CakeTier {
  id                                       Int            @id @default(autoincrement())
  cakeOrderId                              Int
  tierIndex                                Int
  tierSizeId                               Int
  flavor                                   String?
  filling                                  String?
  finishType                               String?
  createdAt                                DateTime       @default(now())
  updatedAt                                DateTime @updatedAt
  batterMultiplier                         Decimal?       @db.Decimal(10, 3)
  batterRecipeId                           Int?
  fillingMultiplier                        Decimal?       @db.Decimal(10, 3)
  fillingRecipeId                          Int?
  frostingMultiplier                       Decimal?       @db.Decimal(10, 3)
  frostingRecipeId                         Int?
  frostingComplexity                       Int            @default(2) // 1=light, 2=medium, 3=heavy (rosettes, etc.)
  cakeboardNotes                           String?
  cakeboardShape                           String?
  cakeboardSizeInches                      Int?
  cakeboardTypeId                          Int?
  Recipe_CakeTier_batterRecipeIdToRecipe   Recipe?        @relation("CakeTier_batterRecipeIdToRecipe", fields: [batterRecipeId], references: [id])
  CakeOrder                                CakeOrder      @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  CakeboardType                            CakeboardType? @relation(fields: [cakeboardTypeId], references: [id])
  Recipe_CakeTier_fillingRecipeIdToRecipe  Recipe?        @relation("CakeTier_fillingRecipeIdToRecipe", fields: [fillingRecipeId], references: [id])
  Recipe_CakeTier_frostingRecipeIdToRecipe Recipe?        @relation("CakeTier_frostingRecipeIdToRecipe", fields: [frostingRecipeId], references: [id])
  TierSize                                 TierSize       @relation(fields: [tierSizeId], references: [id])
  ProductionBatchTier                      ProductionBatchTier[]

  @@unique([cakeOrderId, tierIndex])
}

model CakeboardType {
  id              Int        @id @default(autoincrement())
  name            String     @unique
  description     String?
  vendorId        Int?
  availableSizes  String?
  availableShapes String?
  costPerUnit     Decimal?   @db.Decimal(10, 2)
  notes           String?
  isActive        Boolean    @default(true)
  sortOrder       Int        @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  CakeTier        CakeTier[]
  Vendor          Vendor?    @relation(fields: [vendorId], references: [id])
}

model Customer {
  id        Int         @id @default(autoincrement())
  name      String
  email     String?
  phone     String?
  address   String?
  notes     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime @updatedAt
  birthday  DateTime?
  company   String?
  CakeOrder CakeOrder[]
  Quote     Quote[]

  @@index([company])
  @@index([email])
  @@index([name])
  @@index([phone])
}

model DecorationTechnique {
  id                 Int               @id @default(autoincrement())
  sku                String            @unique
  name               String
  category           String
  subcategory        String
  skillLevel         SkillLevel
  description        String
  unit               DecorationUnit
  defaultCostPerUnit Decimal           @db.Decimal(10, 2)
  laborMinutes       Int
  wasteFactorPercent Int
  materialGrade      MaterialGrade
  toolsRequired      String
  imageReference     String?
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime @updatedAt
  baseCakeSize       String            @default("6\" round")
  laborRoleId        Int?
  LaborRole          LaborRole?        @relation(fields: [laborRoleId], references: [id])
  OrderDecoration    OrderDecoration[]
  QuoteDecoration    QuoteDecoration[]
}

model DeliveryStartPoint {
  id        Int      @id @default(autoincrement())
  name      String
  address   String
  latitude  Decimal? @db.Decimal(10, 7)
  longitude Decimal? @db.Decimal(10, 7)
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeliveryZone {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  minDistance Decimal?    @db.Decimal(10, 2)
  maxDistance Decimal?    @db.Decimal(10, 2)
  baseFee     Decimal     @db.Decimal(10, 2)
  perMileFee  Decimal?    @db.Decimal(10, 2)
  isActive    Boolean     @default(true)
  sortOrder   Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime @updatedAt
  CakeOrder   CakeOrder[]
  Quote       Quote[]
}

model FieldOption {
  id        Int      @id @default(autoincrement())
  category  String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, name])
  @@index([category])
}

model Ingredient {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  unit             String
  costPerUnit      Decimal            @db.Decimal(10, 6)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime @updatedAt
  IngredientVendor IngredientVendor[]
  RecipeIngredient RecipeIngredient[]
}

model IngredientVendor {
  id                    Int        @id @default(autoincrement())
  ingredientId          Int
  vendorId              Int
  vendorSku             String?
  vendorProductName     String?
  packSize              Decimal    @db.Decimal(10, 3)
  packUnit              String
  pricePerPack          Decimal    @db.Decimal(10, 2)
  costPerIngredientUnit Decimal?   @db.Decimal(10, 6)
  reorderUrl            String?
  isPreferred           Boolean    @default(false)
  lastPurchaseDate      DateTime?
  notes                 String?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime @updatedAt
  Ingredient            Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  Vendor                Vendor     @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([ingredientId, vendorId])
  @@index([ingredientId])
  @@index([vendorId])
}

model LaborRole {
  id                  Int                   @id @default(autoincrement())
  name                String                @unique
  description         String?
  hourlyRate          Decimal               @db.Decimal(10, 2)
  sortOrder           Int                   @default(0)
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  DecorationTechnique DecorationTechnique[]
  MenuItem            MenuItem[]
  Recipe              Recipe[]
  TierSize            TierSize[]
  StaffRole           StaffRole[]
}

model Staff {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  email           String?          @unique
  phone           String?
  isActive        Boolean          @default(true)
  isManager       Boolean          @default(false)
  hireDate        DateTime?
  notes           String?
  sortOrder       Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  StaffRole                    StaffRole[]
  OrderAssignment              OrderAssignment[]
  ProductionTask_assigned      ProductionTask[]          @relation("StaffAssigned")
  ProductionTask_completed     ProductionTask[]          @relation("StaffCompleted")
  TaskSignoff                  TaskSignoff[]
  ProductionPrepSignoff        ProductionPrepSignoff[]
  StockProductionTask          StockProductionTask[]     @relation("StaffStockAssigned")

  @@index([name])
  @@index([isActive])
}

model StaffRole {
  id          Int       @id @default(autoincrement())
  staffId     Int
  laborRoleId Int
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())

  Staff       Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  LaborRole   LaborRole @relation(fields: [laborRoleId], references: [id], onDelete: Cascade)

  @@unique([staffId, laborRoleId])
  @@index([staffId])
  @@index([laborRoleId])
}

model OrderAssignment {
  id          Int       @id @default(autoincrement())
  orderId     Int       @unique
  staffId     Int
  assignedAt  DateTime  @default(now())
  assignedBy  String?
  notes       String?

  CakeOrder   CakeOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Staff       Staff     @relation(fields: [staffId], references: [id])

  @@index([orderId])
  @@index([staffId])
}

model ProductionPrepSignoff {
  id              Int                    @id @default(autoincrement())
  orderId         Int                    @unique
  status          PrepSignoffStatus      @default(NOT_STARTED)
  checklistItems  Json                   @default("{}")
  signedById      Int?
  signedAt        DateTime?
  managerNotes    String?
  lockedAt        DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  CakeOrder       CakeOrder              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  SignedBy        Staff?                 @relation(fields: [signedById], references: [id])

  @@index([orderId])
  @@index([status])
}

enum PrepSignoffStatus {
  NOT_STARTED
  IN_REVIEW
  SIGNED_OFF
}

model MenuItem {
  id                                       Int         @id @default(autoincrement())
  productTypeId                            Int
  name                                     String
  description                              String?
  batterRecipeId                           Int?
  fillingRecipeId                          Int?
  frostingRecipeId                         Int?
  yieldsPerRecipe                          Int?
  menuPrice                                Decimal     @db.Decimal(10, 2)
  laborMinutes                             Int?
  laborRoleId                              Int?
  decorationLevel                          String?
  defaultPackagingId                       Int?
  isActive                                 Boolean     @default(true)
  sortOrder                                Int         @default(0)
  imageUrl                                 String?
  createdAt                                DateTime    @default(now())
  updatedAt                                DateTime @updatedAt
  Recipe_MenuItem_batterRecipeIdToRecipe   Recipe?     @relation("MenuItem_batterRecipeIdToRecipe", fields: [batterRecipeId], references: [id])
  Packaging                                Packaging?  @relation(fields: [defaultPackagingId], references: [id])
  Recipe_MenuItem_fillingRecipeIdToRecipe  Recipe?     @relation("MenuItem_fillingRecipeIdToRecipe", fields: [fillingRecipeId], references: [id])
  Recipe_MenuItem_frostingRecipeIdToRecipe Recipe?     @relation("MenuItem_frostingRecipeIdToRecipe", fields: [frostingRecipeId], references: [id])
  LaborRole                                LaborRole?  @relation(fields: [laborRoleId], references: [id])
  ProductType                              ProductType @relation(fields: [productTypeId], references: [id])
  OrderItem                                OrderItem[]
  QuoteItem                                QuoteItem[]
  VolumeBreakpoint                         VolumeBreakpoint[]

  @@index([productTypeId])
}

// Volume-based pricing for bulk orders
model VolumeBreakpoint {
  id              Int       @id @default(autoincrement())
  menuItemId      Int?      // For specific menu item
  productTypeId   Int?      // OR for entire product category
  minQuantity     Int       // Minimum quantity for this tier
  maxQuantity     Int?      // Max quantity (null = unlimited)
  discountPercent Decimal   @db.Decimal(5, 2) // e.g., 10.00 = 10%
  pricePerUnit    Decimal?  @db.Decimal(10, 2) // OR fixed per-unit price
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  MenuItem        MenuItem?    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  ProductType     ProductType? @relation(fields: [productTypeId], references: [id], onDelete: Cascade)

  @@index([menuItemId])
  @@index([productTypeId])
}

model OrderDecoration {
  id                    Int                 @id @default(autoincrement())
  cakeOrderId           Int
  decorationTechniqueId Int
  quantity              Int                 @default(1)
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime @updatedAt
  tierIndices           Int[]               @default([])
  unitOverride          DecorationUnit?
  CakeOrder             CakeOrder           @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  DecorationTechnique   DecorationTechnique @relation(fields: [decorationTechniqueId], references: [id])

  @@unique([cakeOrderId, decorationTechniqueId])
}

model OrderItem {
  id                 Int                  @id @default(autoincrement())
  cakeOrderId        Int
  itemType           OrderItemType
  menuItemId         Int?
  productTypeId      Int?
  quantity           Int                  @default(1)
  unitPrice          Decimal?             @db.Decimal(10, 2)
  itemName           String?
  notes              String?
  packagingId        Int?
  packagingQty       Int?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime @updatedAt
  CakeOrder          CakeOrder            @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  MenuItem           MenuItem?            @relation(fields: [menuItemId], references: [id])
  Packaging          Packaging?           @relation(fields: [packagingId], references: [id])
  ProductType        ProductType?         @relation(fields: [productTypeId], references: [id])
  OrderItemPackaging OrderItemPackaging[]

  @@index([cakeOrderId])
  @@index([menuItemId])
}

model OrderItemPackaging {
  id          Int       @id @default(autoincrement())
  orderItemId Int
  packagingId Int
  quantity    Int       @default(1)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  OrderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  Packaging   Packaging @relation(fields: [packagingId], references: [id])

  @@unique([orderItemId, packagingId])
  @@index([orderItemId])
  @@index([packagingId])
}

model OrderPackaging {
  id          Int       @id @default(autoincrement())
  cakeOrderId Int
  packagingId Int
  quantity    Int       @default(1)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt
  CakeOrder   CakeOrder @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  Packaging   Packaging @relation(fields: [packagingId], references: [id])

  @@unique([cakeOrderId, packagingId])
}

model Packaging {
  id                 Int                  @id @default(autoincrement())
  name               String               @unique
  type               PackagingType
  description        String?
  capacity           Int?
  sizeFit            String?
  costPerUnit        Decimal              @db.Decimal(10, 4)
  vendor             String?
  sku                String?
  reorderUrl         String?
  isActive           Boolean              @default(true)
  sortOrder          Int                  @default(0)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime @updatedAt
  MenuItem           MenuItem[]
  OrderItem          OrderItem[]
  OrderItemPackaging OrderItemPackaging[]
  OrderPackaging     OrderPackaging[]
  QuoteItem          QuoteItem[]
  QuotePackaging     QuotePackaging[]

  @@index([type])
}

model ProductType {
  id              Int         @id @default(autoincrement())
  name            String      @unique
  category        String
  baseUnit        String
  description     String?
  defaultRecipeId Int?
  isActive        Boolean     @default(true)
  sortOrder       Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime @updatedAt
  MenuItem         MenuItem[]
  OrderItem        OrderItem[]
  Recipe           Recipe?     @relation(fields: [defaultRecipeId], references: [id])
  QuoteItem        QuoteItem[]
  VolumeBreakpoint VolumeBreakpoint[]
}

model ProductionTask {
  id                   Int              @id @default(autoincrement())
  orderId              Int
  taskType             String
  taskName             String
  productType          String?
  itemIndex            Int?
  scheduledDate        DateTime
  scheduledStart       DateTime?
  scheduledEnd         DateTime?
  durationMinutes      Int?
  status               TaskStatus       @default(PENDING)
  assignedTo           String?
  assignedToId         Int?
  startedAt            DateTime?
  completedAt          DateTime?
  completedBy          String?
  completedById        Int?
  dependsOnId          Int?
  notes                String?

  // Multi-day scheduling support
  dayOffset            Int              @default(0)   // Days before event (-3, -2, -1, 0)
  spansDays            Int              @default(1)   // How many days this task spans
  scheduledEndDate     DateTime?                      // End date for multi-day tasks

  createdAt            DateTime         @default(now())
  updatedAt            DateTime @updatedAt
  ProductionTask       ProductionTask?  @relation("ProductionTaskToProductionTask", fields: [dependsOnId], references: [id])
  other_ProductionTask ProductionTask[] @relation("ProductionTaskToProductionTask")
  CakeOrder            CakeOrder        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  TaskSignoff          TaskSignoff[]
  AssignedToStaff      Staff?           @relation("StaffAssigned", fields: [assignedToId], references: [id])
  CompletedByStaff     Staff?           @relation("StaffCompleted", fields: [completedById], references: [id])

  @@index([orderId])
  @@index([scheduledDate])
  @@index([dayOffset])
  @@index([status])
  @@index([assignedToId])
}

model Quote {
  id                 Int               @id @default(autoincrement())
  quoteNumber        String            @unique
  customerId         Int?
  customerName       String
  eventDate          DateTime
  eventType          String?
  theme              String?
  occasion           String?
  colors             String?
  accentColors       String?
  cakeType           CakeType?
  desiredServings    Int?
  isDelivery         Boolean           @default(false)
  deliveryZoneId     Int?
  deliveryDistance   Decimal?          @db.Decimal(10, 2)
  deliveryContact    String?
  deliveryPhone      String?
  deliveryTime       DateTime?
  deliveryAddress    String?
  bakerHours         Decimal?          @db.Decimal(10, 2)
  assistantHours     Decimal?          @db.Decimal(10, 2)
  topperType         String?
  topperText         String?
  customTopperFee    Decimal?          @db.Decimal(10, 2)
  markupPercent      Decimal           @db.Decimal(10, 4)
  discountType       DiscountType?
  discountValue      Decimal?          @db.Decimal(10, 2)
  discountReason     String?
  status             QuoteStatus       @default(DRAFT)
  expiresAt          DateTime?
  notes              String?
  termsAndConditions String?
  convertedOrderId   Int?              @unique
  createdAt          DateTime          @default(now())
  updatedAt          DateTime @updatedAt
  sentAt             DateTime?
  lockedAt           DateTime?
  lockedCosting      String?
  depositPercent     Decimal?          @db.Decimal(5, 2)
  depositType        String?           // 'PERCENT' or 'FIXED'
  depositAmount      Decimal?          @db.Decimal(10, 2) // Fixed dollar amount for deposit
  originalQuoteId    Int?
  version            Int               @default(1)
  budgetMax          Decimal?          @db.Decimal(10, 2)
  budgetMin          Decimal?          @db.Decimal(10, 2)
  priceAdjustment    Decimal?          @db.Decimal(10, 2) // +/- adjustment to round price (internal only shows both, customer sees adjusted)
  CakeOrder          CakeOrder?        @relation(fields: [convertedOrderId], references: [id])
  Customer           Customer?         @relation(fields: [customerId], references: [id])
  DeliveryZone       DeliveryZone?     @relation(fields: [deliveryZoneId], references: [id])
  Quote              Quote?            @relation("QuoteToQuote", fields: [originalQuoteId], references: [id])
  other_Quote        Quote[]           @relation("QuoteToQuote")
  QuoteDecoration    QuoteDecoration[]
  QuoteItem          QuoteItem[]
  QuotePackaging     QuotePackaging[]
  QuoteTier          QuoteTier[]

  @@index([customerId])
  @@index([eventDate])
  @@index([quoteNumber])
  @@index([status])
}

model QuoteDecoration {
  id                    Int                 @id @default(autoincrement())
  quoteId               Int
  decorationTechniqueId Int
  quantity              Int                 @default(1)
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime @updatedAt
  unitOverride          DecorationUnit?
  tierIndices           Int[]               @default([])
  DecorationTechnique   DecorationTechnique @relation(fields: [decorationTechniqueId], references: [id])
  Quote                 Quote               @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, decorationTechniqueId])
}

model QuoteItem {
  id            Int           @id @default(autoincrement())
  quoteId       Int
  itemType      OrderItemType
  menuItemId    Int?
  productTypeId Int?
  quantity      Int           @default(1)
  unitPrice     Decimal?      @db.Decimal(10, 2)
  itemName      String?
  notes         String?
  packagingId   Int?
  packagingQty  Int?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime @updatedAt
  MenuItem      MenuItem?     @relation(fields: [menuItemId], references: [id])
  Packaging     Packaging?    @relation(fields: [packagingId], references: [id])
  ProductType   ProductType?  @relation(fields: [productTypeId], references: [id])
  Quote         Quote         @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model QuotePackaging {
  id          Int       @id @default(autoincrement())
  quoteId     Int
  packagingId Int
  quantity    Int       @default(1)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt
  Packaging   Packaging @relation(fields: [packagingId], references: [id])
  Quote       Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, packagingId])
}

model QuoteTier {
  id                                        Int      @id @default(autoincrement())
  quoteId                                   Int
  tierIndex                                 Int
  tierSizeId                                Int
  batterRecipeId                            Int?
  batterMultiplier                          Decimal? @db.Decimal(10, 3)
  fillingRecipeId                           Int?
  fillingMultiplier                         Decimal? @db.Decimal(10, 3)
  frostingRecipeId                          Int?
  frostingMultiplier                        Decimal? @db.Decimal(10, 3)
  flavor                                    String?
  filling                                   String?
  finishType                                String?
  createdAt                                 DateTime @default(now())
  updatedAt                                 DateTime @updatedAt
  Recipe_QuoteTier_batterRecipeIdToRecipe   Recipe?  @relation("QuoteTier_batterRecipeIdToRecipe", fields: [batterRecipeId], references: [id])
  Recipe_QuoteTier_fillingRecipeIdToRecipe  Recipe?  @relation("QuoteTier_fillingRecipeIdToRecipe", fields: [fillingRecipeId], references: [id])
  Recipe_QuoteTier_frostingRecipeIdToRecipe Recipe?  @relation("QuoteTier_frostingRecipeIdToRecipe", fields: [frostingRecipeId], references: [id])
  Quote                                     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  TierSize                                  TierSize @relation(fields: [tierSizeId], references: [id])

  @@unique([quoteId, tierIndex])
}

model Recipe {
  id                                           Int                @id @default(autoincrement())
  name                                         String             @unique
  type                                         RecipeType
  yieldDescription                             String
  createdAt                                    DateTime           @default(now())
  updatedAt                                    DateTime @updatedAt
  laborMinutes                                 Int?
  laborRoleId                                  Int?
  bakeMinutes                                  Int?
  coolMinutes                                  Int?
  instructions                                 String?
  prepMinutes                                  Int?
  yieldVolumeMl                                Int?
  CakeTier_CakeTier_batterRecipeIdToRecipe     CakeTier[]         @relation("CakeTier_batterRecipeIdToRecipe")
  CakeTier_CakeTier_fillingRecipeIdToRecipe    CakeTier[]         @relation("CakeTier_fillingRecipeIdToRecipe")
  CakeTier_CakeTier_frostingRecipeIdToRecipe   CakeTier[]         @relation("CakeTier_frostingRecipeIdToRecipe")
  MenuItem_MenuItem_batterRecipeIdToRecipe     MenuItem[]         @relation("MenuItem_batterRecipeIdToRecipe")
  MenuItem_MenuItem_fillingRecipeIdToRecipe    MenuItem[]         @relation("MenuItem_fillingRecipeIdToRecipe")
  MenuItem_MenuItem_frostingRecipeIdToRecipe   MenuItem[]         @relation("MenuItem_frostingRecipeIdToRecipe")
  ProductType                                  ProductType[]
  QuoteTier_QuoteTier_batterRecipeIdToRecipe   QuoteTier[]        @relation("QuoteTier_batterRecipeIdToRecipe")
  QuoteTier_QuoteTier_fillingRecipeIdToRecipe  QuoteTier[]        @relation("QuoteTier_fillingRecipeIdToRecipe")
  QuoteTier_QuoteTier_frostingRecipeIdToRecipe QuoteTier[]        @relation("QuoteTier_frostingRecipeIdToRecipe")
  LaborRole                                    LaborRole?         @relation(fields: [laborRoleId], references: [id])
  RecipeIngredient                             RecipeIngredient[]
  InventoryItem                                InventoryItem[]
  InventoryItemRecipe                          InventoryItemRecipe[]
}

model RecipeIngredient {
  id           Int        @id @default(autoincrement())
  recipeId     Int
  ingredientId Int
  quantity     Decimal    @db.Decimal(10, 3)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime @updatedAt
  Ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  Recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TaskSignoff {
  id             Int            @id @default(autoincrement())
  taskId         Int
  signoffType    String
  signedBy       String
  signedById     Int?
  signedAt       DateTime       @default(now())
  notes          String?
  ProductionTask ProductionTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  SignedByStaff  Staff?         @relation(fields: [signedById], references: [id])

  @@index([taskId])
  @@index([signedById])
}

model TierSize {
  id              Int             @id @default(autoincrement())
  name            String          @unique
  diameterCm      Decimal         @db.Decimal(10, 2)
  heightCm        Decimal         @db.Decimal(10, 2)
  servings        Int
  createdAt       DateTime        @default(now())
  updatedAt       DateTime @updatedAt
  shape           String          @default("Round")
  lengthCm        Decimal?        @db.Decimal(10, 2)
  assemblyMinutes Int?
  assemblyRoleId  Int?
  volumeMl        Int?
  widthCm         Decimal?        @db.Decimal(10, 2)
  CakeTier        CakeTier[]
  QuoteTier       QuoteTier[]
  LaborRole       LaborRole?      @relation(fields: [assemblyRoleId], references: [id])
  InventoryItem   InventoryItem[]
}

model Vendor {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  website          String?
  contactName      String?
  contactPhone     String?
  contactEmail     String?
  notes            String?
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime @updatedAt
  CakeboardType    CakeboardType[]
  IngredientVendor IngredientVendor[]
}

enum CakeType {
  ROUND
  SHEET
  TIERED
  SCULPTED
  CUPCAKES
  OTHER
}

enum DecorationUnit {
  CAKE
  TIER
  SET
  SINGLE
}

enum DiscountType {
  PERCENT
  FIXED
}

enum MaterialGrade {
  STANDARD
  PREMIUM
  LUXURY
}

enum OrderItemType {
  CAKE_TIER
  MENU_ITEM
  CUSTOM
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PackagingType {
  BOX
  CONTAINER
  LINER
  BOARD
  WRAP
  BAG
  INSERT
  OTHER
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
}

enum RecipeType {
  BATTER
  FILLING
  FROSTING
}

enum SkillLevel {
  LOW
  MEDIUM
  HIGH
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
  SKIPPED
}

// ============================================
// INVENTORY & STOCK PRODUCTION MODELS
// ============================================

// Types of stock items that can be pre-made
enum StockProductType {
  CAKE_TIER       // Pre-baked/stacked cake tiers
  CUPCAKE         // Pre-made cupcakes
  COOKIE          // Pre-made cookies
  CAKE_POP        // Pre-made cake pops
  FROSTING        // Pre-made frosting batches
  FILLING         // Pre-made filling batches
  FONDANT         // Pre-made fondant
  OTHER           // Other stock items
}

// Status for stock production tasks
enum StockTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Represents a type of inventory item (e.g., "6-inch vanilla cake tier")
model InventoryItem {
  id              Int              @id @default(autoincrement())
  sku             String           @unique
  name            String           // e.g., "6-inch Vanilla Cake Tier"
  productType     StockProductType
  tierSizeId      Int?             // For cake tiers, links to size
  recipeId        Int?             // The recipe used to make this
  flavor          String?          // e.g., "vanilla", "chocolate"
  description     String?
  unit            String           @default("each") // each, dozen, batch
  currentStock    Int              @default(0)
  minStock        Int              @default(0)      // Reorder point
  maxStock        Int?                              // Target level
  shelfLifeDays   Int?                              // How long it lasts
  storageLocation String?                           // Where it's stored
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  TierSize               TierSize?               @relation(fields: [tierSizeId], references: [id])
  Recipe                 Recipe?                 @relation(fields: [recipeId], references: [id])
  InventoryLot           InventoryLot[]
  StockProductionTask    StockProductionTask[]
  InventoryReservation   InventoryReservation[]
  InventoryItemRecipe    InventoryItemRecipe[]

  @@index([productType])
  @@index([flavor])
  @@index([tierSizeId])
}

// Links inventory items to multiple recipes with quantities
// e.g., Vanilla Cupcake needs both Vanilla Batter (0.5oz) and Vanilla Buttercream (0.5oz)
model InventoryItemRecipe {
  id               Int           @id @default(autoincrement())
  inventoryItemId  Int
  recipeId         Int
  recipeType       String        // BATTER, FILLING, FROSTING - what role this recipe plays
  quantityPerUnit  Decimal       @db.Decimal(10, 2) // How much recipe per item (oz)
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  InventoryItem    InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  Recipe           Recipe        @relation(fields: [recipeId], references: [id])

  @@unique([inventoryItemId, recipeId])
  @@index([inventoryItemId])
  @@index([recipeId])
}

// Individual lots/batches for FIFO tracking
model InventoryLot {
  id              Int           @id @default(autoincrement())
  inventoryItemId Int
  quantity        Int           // Current quantity in this lot
  originalQty     Int           // Original quantity produced
  producedAt      DateTime      @default(now())
  expiresAt       DateTime?     // Calculated from shelfLifeDays
  producedByTaskId Int?         // Which stock task made this
  lotNumber       String?       // Optional lot tracking number
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  InventoryItem       InventoryItem        @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  StockProductionTask StockProductionTask? @relation(fields: [producedByTaskId], references: [id])
  InventoryReservation InventoryReservation[]

  @@index([inventoryItemId])
  @@index([expiresAt])
  @@index([producedAt])
}

// Production tasks for making stock (not tied to orders)
model StockProductionTask {
  id               Int             @id @default(autoincrement())
  inventoryItemId  Int
  productionBatchId Int?           // Link to production batch when assigned
  taskType         String          // BAKE, STACK, DECORATE, etc.
  taskName         String          // e.g., "Bake 10x 6-inch Vanilla Tiers"
  targetQuantity   Int             // How many to make
  completedQuantity Int            @default(0) // Progress tracking for bulk
  scheduledDate    DateTime
  scheduledStart   DateTime?
  scheduledEnd     DateTime?
  durationMinutes  Int?
  status           StockTaskStatus @default(PENDING)
  assignedTo       String?
  assignedToId     Int?
  startedAt        DateTime?
  completedAt      DateTime?
  priority         Int             @default(0) // Higher = more urgent
  isAutoGenerated  Boolean         @default(false) // True if auto-replenishment
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  InventoryItem    InventoryItem    @relation(fields: [inventoryItemId], references: [id])
  ProductionBatch  ProductionBatch? @relation(fields: [productionBatchId], references: [id])
  AssignedToStaff  Staff?           @relation("StaffStockAssigned", fields: [assignedToId], references: [id])
  InventoryLot     InventoryLot[]   // Lots produced by this task

  @@index([inventoryItemId])
  @@index([productionBatchId])
  @@index([scheduledDate])
  @@index([status])
  @@index([assignedToId])
}

// Tracks when an order reserves stock (FIFO allocation)
model InventoryReservation {
  id              Int       @id @default(autoincrement())
  orderId         Int
  inventoryItemId Int
  inventoryLotId  Int?      // Specific lot reserved (FIFO)
  quantity        Int
  reservedAt      DateTime  @default(now())
  usedAt          DateTime? // When actually used for order
  status          String    @default("RESERVED") // RESERVED, USED, CANCELLED

  CakeOrder       CakeOrder     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  InventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  InventoryLot    InventoryLot? @relation(fields: [inventoryLotId], references: [id])

  @@index([orderId])
  @@index([inventoryItemId])
  @@index([status])
}

// ============================================
// PRODUCTION BATCH MODELS
// ============================================

// Status for production batches
enum ProductionBatchStatus {
  DRAFT           // Being assembled, not finalized
  SCHEDULED       // Assigned to a date
  IN_PROGRESS     // Currently being worked on
  COMPLETED       // Finished
}

// Batch type determines what kind of work this batch represents
enum ProductionBatchType {
  BAKE            // Baking cake batter
  PREP            // Making frosting/filling
  FROST           // Applying frosting to cakes
  STACK           // Stacking/assembling tiers
  DECORATE        // Decoration work
}

// Configurable batch types with dependencies and lead times
// Admin can add custom types (e.g., "COLOR_BC" for coloring buttercream)
model BatchTypeConfig {
  id            Int      @id @default(autoincrement())
  code          String   @unique  // BAKE, PREP, STACK, DECORATE, or custom codes
  name          String            // Display name (e.g., "Bake Cakes", "Make Frosting")
  description   String?           // Optional description of this step
  dependsOn     String?           // JSON array of dependency codes, e.g., '["BAKE", "PREP"]'
  leadTimeDays  Int      @default(1)  // Days before event this should be scheduled
  sortOrder     Int      @default(0)  // Order in workflow sequence
  isBatchable   Boolean  @default(true)  // Can multiple orders be batched together?
  isActive      Boolean  @default(true)  // Is this type currently in use?
  color         String?           // Optional color for UI (e.g., "orange", "#FF5722")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([sortOrder])
  @@index([isActive])
}

// A production batch groups multiple tiers that share the same recipe/task
// Managers manually associate tiers with batches for weekly planning
model ProductionBatch {
  id               Int                     @id @default(autoincrement())
  name             String                  // e.g., "Vanilla Buttercream - Week of Dec 23"
  batchType        ProductionBatchType
  recipeId         Int?                    // Optional: the recipe this batch is for
  recipeName       String?                 // Denormalized recipe name for display
  scheduledDate    DateTime?               // When the batch is scheduled (legacy single-day)
  status           ProductionBatchStatus   @default(DRAFT)
  assignedToId     Int?
  assignedTo       String?                 // Denormalized staff name
  notes            String?

  // Multi-day scheduling support
  scheduledStartDate  DateTime?            // First day of batch (null = use scheduledDate)
  scheduledEndDate    DateTime?            // Last day of batch (null = single day)
  leadTimeDays        Int?                 // Days before event this should start (-3, -2, etc.)
  durationDays        Int         @default(1)  // How many days this batch spans

  // Computed/cached values (updated when tiers change)
  totalTiers       Int                     @default(0)
  totalServings    Int                     @default(0)
  totalSurfaceArea Int                     @default(0)  // sq inches
  totalButtercream Decimal                 @default(0)  @db.Decimal(10, 2) // oz

  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  ProductionBatchTier  ProductionBatchTier[]
  StockProductionTask  StockProductionTask[]  // Stock items linked to this batch

  @@index([batchType])
  @@index([scheduledDate])
  @@index([scheduledStartDate])
  @@index([status])
}

// Junction table linking tiers to batches
// A tier can be in multiple batches (one for BAKE, one for PREP, one for FROST)
model ProductionBatchTier {
  id          Int             @id @default(autoincrement())
  batchId     Int
  tierId      Int
  addedAt     DateTime        @default(now())
  addedBy     String?         // Who added this tier to the batch
  notes       String?

  ProductionBatch ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  CakeTier        CakeTier        @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@unique([batchId, tierId])
  @@index([batchId])
  @@index([tierId])
}
