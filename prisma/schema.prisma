generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CakeOrder {
  id               Int               @id @default(autoincrement())
  customerName     String?
  eventDate        DateTime
  notes            String?
  servingsTarget   Int?
  estimatedHours   Decimal           @db.Decimal(10, 2)
  status           OrderStatus       @default(DRAFT)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  customerId       Int?
  size             String?
  cakeType         CakeType?
  colors           String?
  deliveryAddress  String?
  deliveryContact  String?
  deliveryPhone    String?
  deliveryTime     DateTime?
  isDelivery       Boolean           @default(false)
  occasion         String?
  theme            String?
  customTopperFee  Decimal?          @db.Decimal(10, 2)
  topperText       String?
  topperType       String?
  deliveryZoneId   Int?
  deliveryDistance Decimal?          @db.Decimal(10, 2)
  discountReason   String?
  discountType     DiscountType?
  discountValue    Decimal?          @db.Decimal(10, 2)
  assistantHours   Decimal?          @db.Decimal(10, 2)
  bakerHours       Decimal?          @db.Decimal(10, 2)
  accentColors     String?
  desiredServings  Int?
  markupPercent    Decimal?          @db.Decimal(10, 4)
  Customer         Customer?         @relation(fields: [customerId], references: [id])
  DeliveryZone     DeliveryZone?     @relation(fields: [deliveryZoneId], references: [id])
  CakeTier         CakeTier[]
  OrderDecoration  OrderDecoration[]
  OrderItem        OrderItem[]
  OrderPackaging   OrderPackaging[]
  ProductionTask   ProductionTask[]
  Quote            Quote?

  @@index([customerId])
  @@index([eventDate])
  @@index([status])
}

model CakeTier {
  id                                       Int       @id @default(autoincrement())
  cakeOrderId                              Int
  tierIndex                                Int
  tierSizeId                               Int
  flavor                                   String?
  filling                                  String?
  finishType                               String?
  createdAt                                DateTime  @default(now())
  updatedAt                                DateTime
  batterMultiplier                         Decimal?  @db.Decimal(10, 3)
  batterRecipeId                           Int?
  fillingMultiplier                        Decimal?  @db.Decimal(10, 3)
  fillingRecipeId                          Int?
  frostingMultiplier                       Decimal?  @db.Decimal(10, 3)
  frostingRecipeId                         Int?
  Recipe_CakeTier_batterRecipeIdToRecipe   Recipe?   @relation("CakeTier_batterRecipeIdToRecipe", fields: [batterRecipeId], references: [id])
  CakeOrder                                CakeOrder @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  Recipe_CakeTier_fillingRecipeIdToRecipe  Recipe?   @relation("CakeTier_fillingRecipeIdToRecipe", fields: [fillingRecipeId], references: [id])
  Recipe_CakeTier_frostingRecipeIdToRecipe Recipe?   @relation("CakeTier_frostingRecipeIdToRecipe", fields: [frostingRecipeId], references: [id])
  TierSize                                 TierSize  @relation(fields: [tierSizeId], references: [id])

  @@unique([cakeOrderId, tierIndex])
}

model Customer {
  id        Int         @id @default(autoincrement())
  name      String
  email     String?
  phone     String?
  address   String?
  notes     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime
  birthday  DateTime?
  company   String?
  CakeOrder CakeOrder[]
  Quote     Quote[]

  @@index([company])
  @@index([email])
  @@index([name])
  @@index([phone])
}

model DecorationTechnique {
  id                 Int               @id @default(autoincrement())
  sku                String            @unique
  name               String
  category           String
  subcategory        String
  skillLevel         SkillLevel
  description        String
  unit               DecorationUnit
  defaultCostPerUnit Decimal           @db.Decimal(10, 2)
  laborMinutes       Int
  wasteFactorPercent Int
  materialGrade      MaterialGrade
  toolsRequired      String
  imageReference     String?
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime
  baseCakeSize       String            @default("6\" round")
  laborRoleId        Int?
  LaborRole          LaborRole?        @relation(fields: [laborRoleId], references: [id])
  OrderDecoration    OrderDecoration[]
  QuoteDecoration    QuoteDecoration[]
}

model DeliveryStartPoint {
  id        Int      @id @default(autoincrement())
  name      String
  address   String
  latitude  Decimal? @db.Decimal(10, 7)
  longitude Decimal? @db.Decimal(10, 7)
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model DeliveryZone {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  minDistance Decimal?    @db.Decimal(10, 2)
  maxDistance Decimal?    @db.Decimal(10, 2)
  baseFee     Decimal     @db.Decimal(10, 2)
  perMileFee  Decimal?    @db.Decimal(10, 2)
  isActive    Boolean     @default(true)
  sortOrder   Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  CakeOrder   CakeOrder[]
  Quote       Quote[]
}

model FieldOption {
  id        Int      @id @default(autoincrement())
  category  String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([category, name])
  @@index([category])
}

model Ingredient {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  unit             String
  costPerUnit      Decimal            @db.Decimal(10, 6)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  IngredientVendor IngredientVendor[]
  RecipeIngredient RecipeIngredient[]
}

model IngredientVendor {
  id                    Int        @id @default(autoincrement())
  ingredientId          Int
  vendorId              Int
  vendorSku             String?
  vendorProductName     String?
  packSize              Decimal    @db.Decimal(10, 3)
  packUnit              String
  pricePerPack          Decimal    @db.Decimal(10, 2)
  costPerIngredientUnit Decimal?   @db.Decimal(10, 6)
  reorderUrl            String?
  isPreferred           Boolean    @default(false)
  lastPurchaseDate      DateTime?
  notes                 String?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime
  Ingredient            Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  Vendor                Vendor     @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([ingredientId, vendorId])
  @@index([ingredientId])
  @@index([vendorId])
}

model LaborRole {
  id                  Int                   @id @default(autoincrement())
  name                String                @unique
  description         String?
  hourlyRate          Decimal               @db.Decimal(10, 2)
  sortOrder           Int                   @default(0)
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  DecorationTechnique DecorationTechnique[]
  MenuItem            MenuItem[]
  Recipe              Recipe[]
  TierSize            TierSize[]
}

model MenuItem {
  id                                       Int         @id @default(autoincrement())
  productTypeId                            Int
  name                                     String
  description                              String?
  batterRecipeId                           Int?
  fillingRecipeId                          Int?
  frostingRecipeId                         Int?
  yieldsPerRecipe                          Int?
  menuPrice                                Decimal     @db.Decimal(10, 2)
  laborMinutes                             Int?
  laborRoleId                              Int?
  decorationLevel                          String?
  defaultPackagingId                       Int?
  isActive                                 Boolean     @default(true)
  sortOrder                                Int         @default(0)
  imageUrl                                 String?
  createdAt                                DateTime    @default(now())
  updatedAt                                DateTime
  Recipe_MenuItem_batterRecipeIdToRecipe   Recipe?     @relation("MenuItem_batterRecipeIdToRecipe", fields: [batterRecipeId], references: [id])
  Packaging                                Packaging?  @relation(fields: [defaultPackagingId], references: [id])
  Recipe_MenuItem_fillingRecipeIdToRecipe  Recipe?     @relation("MenuItem_fillingRecipeIdToRecipe", fields: [fillingRecipeId], references: [id])
  Recipe_MenuItem_frostingRecipeIdToRecipe Recipe?     @relation("MenuItem_frostingRecipeIdToRecipe", fields: [frostingRecipeId], references: [id])
  LaborRole                                LaborRole?  @relation(fields: [laborRoleId], references: [id])
  ProductType                              ProductType @relation(fields: [productTypeId], references: [id])
  OrderItem                                OrderItem[]
  QuoteItem                                QuoteItem[]

  @@index([productTypeId])
}

model OrderDecoration {
  id                    Int                 @id @default(autoincrement())
  cakeOrderId           Int
  decorationTechniqueId Int
  quantity              Int                 @default(1)
  notes                 String?
  unitOverride          DecorationUnit?
  tierIndices           Int[]               @default([])
  createdAt             DateTime            @default(now())
  updatedAt             DateTime
  CakeOrder             CakeOrder           @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  DecorationTechnique   DecorationTechnique @relation(fields: [decorationTechniqueId], references: [id])

  @@unique([cakeOrderId, decorationTechniqueId])
}

model OrderItem {
  id            Int           @id @default(autoincrement())
  cakeOrderId   Int
  itemType      OrderItemType
  menuItemId    Int?
  productTypeId Int?
  quantity      Int           @default(1)
  unitPrice     Decimal?      @db.Decimal(10, 2)
  itemName      String?
  notes         String?
  packagingId   Int?          // Legacy single packaging (kept for backwards compatibility)
  packagingQty  Int?          // Legacy packaging qty
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  CakeOrder     CakeOrder     @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  MenuItem      MenuItem?     @relation(fields: [menuItemId], references: [id])
  Packaging     Packaging?    @relation(fields: [packagingId], references: [id])
  ProductType   ProductType?  @relation(fields: [productTypeId], references: [id])
  OrderItemPackaging OrderItemPackaging[]

  @@index([cakeOrderId])
  @@index([menuItemId])
}

model OrderItemPackaging {
  id          Int       @id @default(autoincrement())
  orderItemId Int
  packagingId Int
  quantity    Int       @default(1)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  OrderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  Packaging   Packaging @relation(fields: [packagingId], references: [id])

  @@unique([orderItemId, packagingId])
  @@index([orderItemId])
  @@index([packagingId])
}

model OrderPackaging {
  id          Int       @id @default(autoincrement())
  cakeOrderId Int
  packagingId Int
  quantity    Int       @default(1)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  CakeOrder   CakeOrder @relation(fields: [cakeOrderId], references: [id], onDelete: Cascade)
  Packaging   Packaging @relation(fields: [packagingId], references: [id])

  @@unique([cakeOrderId, packagingId])
}

model Packaging {
  id             Int              @id @default(autoincrement())
  name           String           @unique
  type           PackagingType
  description    String?
  capacity       Int?
  sizeFit        String?
  costPerUnit    Decimal          @db.Decimal(10, 4)
  vendor         String?
  sku            String?
  reorderUrl     String?
  isActive       Boolean          @default(true)
  sortOrder      Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  MenuItem       MenuItem[]
  OrderItem      OrderItem[]
  OrderItemPackaging OrderItemPackaging[]
  OrderPackaging OrderPackaging[]
  QuoteItem      QuoteItem[]
  QuotePackaging QuotePackaging[]

  @@index([type])
}

model ProductType {
  id              Int         @id @default(autoincrement())
  name            String      @unique
  category        String
  baseUnit        String
  description     String?
  defaultRecipeId Int?
  isActive        Boolean     @default(true)
  sortOrder       Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  MenuItem        MenuItem[]
  OrderItem       OrderItem[]
  Recipe          Recipe?     @relation(fields: [defaultRecipeId], references: [id])
  QuoteItem       QuoteItem[]
}

model ProductionTask {
  id                   Int              @id @default(autoincrement())
  orderId              Int
  taskType             String
  taskName             String
  productType          String?
  itemIndex            Int?
  scheduledDate        DateTime
  scheduledStart       DateTime?
  scheduledEnd         DateTime?
  durationMinutes      Int?
  status               TaskStatus       @default(PENDING)
  assignedTo           String?
  startedAt            DateTime?
  completedAt          DateTime?
  completedBy          String?
  dependsOnId          Int?
  notes                String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime
  ProductionTask       ProductionTask?  @relation("ProductionTaskToProductionTask", fields: [dependsOnId], references: [id])
  other_ProductionTask ProductionTask[] @relation("ProductionTaskToProductionTask")
  CakeOrder            CakeOrder        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  TaskSignoff          TaskSignoff[]

  @@index([orderId])
  @@index([scheduledDate])
  @@index([status])
}

model Quote {
  id                 Int               @id @default(autoincrement())
  quoteNumber        String            @unique
  customerId         Int?
  customerName       String
  eventDate          DateTime
  eventType          String?
  theme              String?
  occasion           String?
  colors             String?
  accentColors       String?
  cakeType           CakeType?
  desiredServings    Int?
  isDelivery         Boolean           @default(false)
  deliveryZoneId     Int?
  deliveryDistance   Decimal?          @db.Decimal(10, 2)
  deliveryContact    String?
  deliveryPhone      String?
  deliveryTime       DateTime?
  deliveryAddress    String?
  bakerHours         Decimal?          @db.Decimal(10, 2)
  assistantHours     Decimal?          @db.Decimal(10, 2)
  topperType         String?
  topperText         String?
  customTopperFee    Decimal?          @db.Decimal(10, 2)
  markupPercent      Decimal           @db.Decimal(10, 4)
  discountType       DiscountType?
  discountValue      Decimal?          @db.Decimal(10, 2)
  discountReason     String?
  status             QuoteStatus       @default(DRAFT)
  expiresAt          DateTime?
  notes              String?
  termsAndConditions String?
  convertedOrderId   Int?              @unique
  createdAt          DateTime          @default(now())
  updatedAt          DateTime
  sentAt             DateTime?
  lockedAt           DateTime?
  lockedCosting      String?
  depositPercent     Decimal?          @db.Decimal(5, 2)
  originalQuoteId    Int?
  version            Int               @default(1)
  budgetMax          Decimal?          @db.Decimal(10, 2)
  budgetMin          Decimal?          @db.Decimal(10, 2)
  CakeOrder          CakeOrder?        @relation(fields: [convertedOrderId], references: [id])
  Customer           Customer?         @relation(fields: [customerId], references: [id])
  DeliveryZone       DeliveryZone?     @relation(fields: [deliveryZoneId], references: [id])
  Quote              Quote?            @relation("QuoteToQuote", fields: [originalQuoteId], references: [id])
  other_Quote        Quote[]           @relation("QuoteToQuote")
  QuoteDecoration    QuoteDecoration[]
  QuoteItem          QuoteItem[]
  QuotePackaging     QuotePackaging[]
  QuoteTier          QuoteTier[]

  @@index([customerId])
  @@index([eventDate])
  @@index([quoteNumber])
  @@index([status])
}

model QuoteDecoration {
  id                    Int                 @id @default(autoincrement())
  quoteId               Int
  decorationTechniqueId Int
  quantity              Int                 @default(1)
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime
  unitOverride          DecorationUnit?
  tierIndices           Int[]               @default([])
  DecorationTechnique   DecorationTechnique @relation(fields: [decorationTechniqueId], references: [id])
  Quote                 Quote               @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, decorationTechniqueId])
}

model QuoteItem {
  id            Int           @id @default(autoincrement())
  quoteId       Int
  itemType      OrderItemType
  menuItemId    Int?
  productTypeId Int?
  quantity      Int           @default(1)
  unitPrice     Decimal?      @db.Decimal(10, 2)
  itemName      String?
  notes         String?
  packagingId   Int?
  packagingQty  Int?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  MenuItem      MenuItem?     @relation(fields: [menuItemId], references: [id])
  Packaging     Packaging?    @relation(fields: [packagingId], references: [id])
  ProductType   ProductType?  @relation(fields: [productTypeId], references: [id])
  Quote         Quote         @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model QuotePackaging {
  id          Int       @id @default(autoincrement())
  quoteId     Int
  packagingId Int
  quantity    Int       @default(1)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  Packaging   Packaging @relation(fields: [packagingId], references: [id])
  Quote       Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, packagingId])
}

model QuoteTier {
  id                                        Int      @id @default(autoincrement())
  quoteId                                   Int
  tierIndex                                 Int
  tierSizeId                                Int
  batterRecipeId                            Int?
  batterMultiplier                          Decimal? @db.Decimal(10, 3)
  fillingRecipeId                           Int?
  fillingMultiplier                         Decimal? @db.Decimal(10, 3)
  frostingRecipeId                          Int?
  frostingMultiplier                        Decimal? @db.Decimal(10, 3)
  flavor                                    String?
  filling                                   String?
  finishType                                String?
  createdAt                                 DateTime @default(now())
  updatedAt                                 DateTime
  Recipe_QuoteTier_batterRecipeIdToRecipe   Recipe?  @relation("QuoteTier_batterRecipeIdToRecipe", fields: [batterRecipeId], references: [id])
  Recipe_QuoteTier_fillingRecipeIdToRecipe  Recipe?  @relation("QuoteTier_fillingRecipeIdToRecipe", fields: [fillingRecipeId], references: [id])
  Recipe_QuoteTier_frostingRecipeIdToRecipe Recipe?  @relation("QuoteTier_frostingRecipeIdToRecipe", fields: [frostingRecipeId], references: [id])
  Quote                                     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  TierSize                                  TierSize @relation(fields: [tierSizeId], references: [id])

  @@unique([quoteId, tierIndex])
}

model Recipe {
  id                                           Int                @id @default(autoincrement())
  name                                         String             @unique
  type                                         RecipeType
  yieldDescription                             String
  createdAt                                    DateTime           @default(now())
  updatedAt                                    DateTime
  laborMinutes                                 Int?
  laborRoleId                                  Int?
  bakeMinutes                                  Int?
  coolMinutes                                  Int?
  instructions                                 String?
  prepMinutes                                  Int?
  yieldVolumeMl                                Int?
  CakeTier_CakeTier_batterRecipeIdToRecipe     CakeTier[]         @relation("CakeTier_batterRecipeIdToRecipe")
  CakeTier_CakeTier_fillingRecipeIdToRecipe    CakeTier[]         @relation("CakeTier_fillingRecipeIdToRecipe")
  CakeTier_CakeTier_frostingRecipeIdToRecipe   CakeTier[]         @relation("CakeTier_frostingRecipeIdToRecipe")
  MenuItem_MenuItem_batterRecipeIdToRecipe     MenuItem[]         @relation("MenuItem_batterRecipeIdToRecipe")
  MenuItem_MenuItem_fillingRecipeIdToRecipe    MenuItem[]         @relation("MenuItem_fillingRecipeIdToRecipe")
  MenuItem_MenuItem_frostingRecipeIdToRecipe   MenuItem[]         @relation("MenuItem_frostingRecipeIdToRecipe")
  ProductType                                  ProductType[]
  QuoteTier_QuoteTier_batterRecipeIdToRecipe   QuoteTier[]        @relation("QuoteTier_batterRecipeIdToRecipe")
  QuoteTier_QuoteTier_fillingRecipeIdToRecipe  QuoteTier[]        @relation("QuoteTier_fillingRecipeIdToRecipe")
  QuoteTier_QuoteTier_frostingRecipeIdToRecipe QuoteTier[]        @relation("QuoteTier_frostingRecipeIdToRecipe")
  LaborRole                                    LaborRole?         @relation(fields: [laborRoleId], references: [id])
  RecipeIngredient                             RecipeIngredient[]
}

model RecipeIngredient {
  id           Int        @id @default(autoincrement())
  recipeId     Int
  ingredientId Int
  quantity     Decimal    @db.Decimal(10, 3)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  Ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  Recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model TaskSignoff {
  id             Int            @id @default(autoincrement())
  taskId         Int
  signoffType    String
  signedBy       String
  signedAt       DateTime       @default(now())
  notes          String?
  ProductionTask ProductionTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TierSize {
  id              Int         @id @default(autoincrement())
  name            String      @unique
  diameterCm      Decimal     @db.Decimal(10, 2)
  heightCm        Decimal     @db.Decimal(10, 2)
  servings        Int
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  shape           String      @default("Round")
  lengthCm        Decimal?    @db.Decimal(10, 2)
  assemblyMinutes Int?
  assemblyRoleId  Int?
  volumeMl        Int?
  widthCm         Decimal?    @db.Decimal(10, 2)
  CakeTier        CakeTier[]
  QuoteTier       QuoteTier[]
  LaborRole       LaborRole?  @relation(fields: [assemblyRoleId], references: [id])
}

model Vendor {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  website          String?
  contactName      String?
  contactPhone     String?
  contactEmail     String?
  notes            String?
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  IngredientVendor IngredientVendor[]
}

enum CakeType {
  ROUND
  SHEET
  TIERED
  SCULPTED
  CUPCAKES
  OTHER
}

enum DecorationUnit {
  CAKE
  TIER
  SET
  SINGLE
}

enum DiscountType {
  PERCENT
  FIXED
}

enum MaterialGrade {
  STANDARD
  PREMIUM
  LUXURY
}

enum OrderItemType {
  CAKE_TIER
  MENU_ITEM
  CUSTOM
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PackagingType {
  BOX
  CONTAINER
  LINER
  BOARD
  WRAP
  BAG
  INSERT
  OTHER
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
}

enum RecipeType {
  BATTER
  FILLING
  FROSTING
}

enum SkillLevel {
  LOW
  MEDIUM
  HIGH
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
  SKIPPED
}
